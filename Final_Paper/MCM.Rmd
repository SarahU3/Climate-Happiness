---
title: "Multilevel_final"
output: pdf_document
fig_caption: yes
---
## Multilevel Analysis

```{r, include=FALSE}
library(repmis)
<<<<<<< HEAD
possibles <- c('~/GitHub', 
               '~/Documents/Hertie 2016/Collaborative Social Science Data/Research Project/GitHub/')
set_valid_wd(possibles)

source('Climate-Happiness/Data/SourceFile.R')
finaldata <- read.csv("All_Merged_Data.csv")
data <- read.csv("Broad_Data.csv")
=======
library(effects)
library(ggplot2)
library(stargazer)
library(nlme)
library(multilevel)
finaldata <- read.csv("~/GitHub/Climate-Happiness/Data/All_Merged_Data.csv")
data <- read.csv("~/GitHub/Climate-Happiness/Data/Broad_Data.csv")
>>>>>>> master
attach(finaldata)

```
Since the pooled OLS and Fixed Effects Models do not account for the nested nature of the data and hence do not allow across-state analysis, Multilevel Coefficient Models (MCM) are applied in order to investigate the effects of individual and Bundesland-level factors on happiness. Not only the MCM examine individual variation within and across groups, but they also permit non-independence of individual factors from the group level variables (i.e. different slopes with varying intercepts). The first step of the MCM investigates whether statistically significant variation between Bundeslaender in terms of mean individual satisfaction exists. Otherwise, simpler OLS and panel-data models are more applicable for the given research. The second step involves exploration of the between-group variation (random effects), while the third step completes the analysis by adding fixed effects factors (both individual- and state-level). 

In addition to the general data set ($data_1$, 61,009 observations) familiar to the reader before, given research utilizes a broader data frame (data2, 142,224 observations) expanding the sample to both employed and non-employed respondents. Gross income, however, is dropped due to the data constraints. The models used for the multilevel analysis and corresponding data sets are summarized below.

* Null.Models (run on $data_1$) checks whether reliable and significant variation between the States exists.

* Model.1 ($data_1$) tests how the effects of environmental concerns and emissions per sq. km. differ across the Bundeslaender.

* Model.2 ($data_1$) incorporates individual-level characteristics (income, age, gender, family status) and explores how these factors impact well-being across and among States. 

* Model.2a ($data_2$) resembles Model.2, except runs on the broader sample of both employed and unemployed respondents dropping income. 

* Model.3 ($data_1$) presents an interaction effect between environmental concerns and age.

* Model.4 ($data_2$) presents an interaction effect between environmental concerns and employment.

### Step 1. Significant variation. 

An unconditional model, *Null.Model*, serves the first purpose: the model only controls for the State that specifies that the variation intercept is a function of residence.

```{r, echo=FALSE}
Null.Model<-lme(satis~1,random=~1|Stateid,data=finaldata,
                  control=list(opt="optim"))
VarCorr(Null.Model)
``` 

The model examines how much of the average individual life satisfaction is explained by the residence of a respondent through R's general purpose optimization routine (opt="optim"). According to the *Null.Model*, the Bundesland variation (intercept variance) is 0.15, while the within-State residual is 2.6.

```{r, echo=FALSE}
GREL.DAT<-GmeanRel(Null.Model)
x <- mean(GREL.DAT$MeanRel)
Null.Model.2<-gls(satis~1,data=finaldata,
                    control=list(opt="optim"))
sigtest <- round((logLik(Null.Model.2)*-2)-(logLik(Null.Model)*-2), digits=3)
```

Furthermore, the *GmeanRel* function (*multilevel* package) yields the mean reliability of 16 Bundeslaender, which, in this case, is substantially high (`r round(mean(GREL.DAT$MeanRel), digits=3)`). As the cut-off point for acceptable reliability is 0.7, the Bundeslaender group reliability meets the threshold. The difference between the -2 log likelihood values of *Null.Model* and *Null.Model.2* tests whether the between-State effect is present compared to the random variation in life satisfaction without any control variables. According to the results, the difference is more than substantially large based on the Chi-Squared distribution with 2 degrees of freedom (`r sigtest`). These results suggest that there is significant State variation in happiness level, which justifies the usage of the MCM. 

### Step 2. Environmental factors

The second step of the MCM looks into how both Bundesland emissions and subjective concerns about the environment influence reported individual life satisfaction. *Model.1* (*lme* function) for the time being does not control for individual characteristics, such as gender, age, employment and family status. *Model.1* serves as the basic tool to understand relationship between the group- and individual-level factors representing the environment. 

```{r, echo=FALSE, messages=FALSE, warnings=FALSE, results = "asis"}
Model.1<-lme(satis~environ+CO2perSqKm,random=~1+environ+CO2perSqKm|Stateid, data=finaldata,
             control=list(opt="optim"))
stargazer::stargazer(Model.1, single.row = TRUE,
                     dep.var.labels = "Life Satisfaction",
                     title = 'Model.1. Environmental Factors ',
                     digits = 5, type = 'latex', header=FALSE)
```

The output demonstrates that both coefficients are negative, as expected. However, a plot of the relationship between emissions and life satisfaction across all Bundeslaender demonstrates that in some States (Niedersachsen, Nordrhein-Westhafen, Baden-Wuerttemberg, Brandenburg) emissions positively influence the well-being of the residents. These results, nevertheless, do not represent the reality, as one should keep in mind numerous omitted variables from this simplistic model. 

```{r, echo=FALSE}
model.01 <-lme(satis~CO2perSqKm,random=~CO2perSqKm|Stateid, data=finaldata, control=list(opt="optim"))
pframe_carbon <- with(finaldata,            expand.grid(Stateid=levels(Stateid),                           CO2perSqKm=seq(min(CO2perSqKm),max(CO2perSqKm),length=51)))
pframe_carbon$satis <- predict(model.01,newdata=pframe_carbon,level=1)
model01 <- ggplot(finaldata,aes(CO2perSqKm,satis,colour=Stateid))+
  geom_point()+
  geom_line(data=pframe_carbon)+
  ylab("Satisfaction")+
  xlab("CO2 emissions/sqkm")
model01 + ggtitle("Effect of emissions/sqkm across States")
```

Simultaneously, stronger environmental concerns do seem to lower well-being across all the Bundeslaender, albeit to a varying degree. Moreover, the graph shows how throughout Germany, life satisfaction level does not differ substantially, if ran against the environmental concerns. This phenomenon is usually observed, as individuals tend to adjust to their life circumstances and judge their quality of life compared to their peers and neighbors.

```{r, echo=FALSE}
finaldata$environ <- as.numeric(as.character(finaldata$environ))
model.02 <-lme(satis~environ,random=~environ|Stateid, data=finaldata, control=list(opt="optim"))
pframe <- with(finaldata,
               expand.grid(Stateid=levels(Stateid),                           environ=seq(min(environ),max(environ),length=3)))
pframe$satis <- predict(model.02,newdata=pframe,level=1)
model02 <- ggplot(finaldata,aes(environ,satis,colour=Stateid))+
  geom_point()+
  geom_line(data=pframe)+
  ylab("Satisfaction")+
  xlab("Concerns about the environment")
model02 + ggtitle("Effects of environmental concerns across States")
```

Furthermore, fixed effects show that general emissions within any given state are indeed negatively related to the individual happiness. However, the negligent magnitude of the coefficient (-0.000063) is also not statistically significant. Consequently, the group-level effect does not significantly differ from the individual-level one. On the other hand, the coefficient of environmental concerns (-0.075) statistically differs from 0. The missing socio-demographic characteristics are explored in the further step.   

### Step 3. Integrated models

*Model.2* covers age, family status, gender, and gross income of the respondents in the sample. The latter two variables are included in the random slope of the model in order to see the variation in these factors across the states. Since the anticipated effects of age and family status are not contentious, these factors are classified as the fixed effects and explain variation within a state. 
The fixed effects output reassures the main Hypothesis: increasing emissions at the State level, although in minimal amounts (-0.00007), negatively correlate with life satisfaction. Similarly, stronger concerns (-0.063) reduce reported well-being. Surprisingly, increasing gross income increases happiness, albeit marginally (0.00013). Women also do seem to be happier than men in general by substantial 0.15 points. As expected, age bears a negative effect (-0.011), while family status increases well-being almost like being a woman (0.166). 

```{r, echo=FALSE, messages=FALSE, warnings=FALSE, results = "asis"}
Model.2 <-lme(satis~CO2perSqKm+environ+GrossIncome+gender+age+fam,random=~environ+CO2perSqKm+GrossIncome+gender|Stateid,data=finaldata,
             control=list(opt="optim")) 
stargazer::stargazer(Model.2, single.row = TRUE,
                     dep.var.labels = "Life Satisfaction",
                     title = 'Model.2. Socio-demographic factors added',
                     digits = 5, type = 'latex', header=FALSE)
```

Random slopes below of the environmental variables, gross income, and gender demonstrate the broad variation of coefficients' values across the Bundeslaender. 

```{r, echo=FALSE}
plot(ranef(Model.2), font.main = 1, main="Model.2. Random slopes")
```

At the same time, *Model.2a*, encompassing a broader sample of employed and unemployed respondents, yields similar results, except that the magnitude of the environmental impacts increase. Gender, on the contrary, has a substantially reduced coefficient due to the inclusion of the unemployed people. Intuitively, being employed significantly enhances individual satisfaction over time (0.214), which partially explains why increasing absolute income does not bring huge changes in life satisfaction. 

```{r, echo=FALSE, messages=FALSE, warnings=FALSE, results = "asis"}
Model.2a<-lme(satis~CO2perSqKm+environ+age+fam+gender+emp,random=~emp+gender+CO2perSqKm+environ|Stateid,data=data,
             control=list(opt="optim"))
stargazer::stargazer(Model.2a, single.row = TRUE,
                     dep.var.labels = "Life Satisfaction",
                     title = 'Model.2a. Broader sample',
                     digits = 5, type = 'latex', header=FALSE)
plot(ranef(Model.2a),font.main = 1, main="Model.2a. Random slopes")
```

### Interaction models

All the models before assume linear relationship between the independent and the dependent variables. In reality, some of the factors might interact while influencing well-being. *Model.3* and *Model.4* scratch the surface of the interaction effects in looking at how environmental concerns of individuals interact with their age and employment status respectively. Age is particularly interesting, since the global issue of climate change has become public only in the recent decades. Hence, older generations might perceive negative environmental changes independently from their subjective well-being, while younger generations might indeed treat environmental conditions as inextricable to their life satisfaction. Therefore, negative effects of environmental degradation might be more acutely felt for the younger cohorts. Simultaneously, older age might signal stronger tendency to adopting conservative values. As a result, either cohort or age effect might interact with environmental concerns of the respondents in shaping their well-being perception. 

Likewise, material well-being, as measured by the employment status of an individual, could be thought to be associated with greater concerns pertaining to the environment. Following the logic held in Maslow's hierarchy of needs, people whose material (and by extension social) needs are met, would tend to focus their attention towards higher goals. Therefore, the stronger environmental concerns are anticipated to have a higher negative effect on the employed respondents compared to their unemployed counterparts. 

<<<<<<< HEAD
Likewise, material well-being, as measured by the employment status of an individual, could be thought to be associated with greater concerns pertaining to the environment. Following the logic held in Maslow's hierarchy of needs, people whose material (and by extension social) needs are met, would tend to focus their attention towards higher goals. Therefore, the stronger environmental concenrs are anticipated to have a higher negatove effect on the employed respondents compared to their unemployed counterparts. 

=======
>>>>>>> master
```{r, echo=FALSE}
Model.3<-lme(satis~fam+gender+environ*age+CO2perSqKm+GrossIncome,
random=~1+environ*age|Stateid,data=finaldata,control=list(opt="optim"))
efage <- effect("environ*age", Model.3)
xage <- as.data.frame(efage)
Model3 <- ggplot(xage, aes(age, fit, color=environ)) + geom_point() + geom_errorbar(aes(ymin=fit-se, ymax=fit+se), width=0.4) + theme_bw(base_size = 12)+
  ylab("Predicted satisfaction values") +
  xlab("Environmental concerns [1-3]")

Model3 + ggtitle("Model.3. Interaction effects of environmental concerns and age")
```
<<<<<<< HEAD
However, as shown in the graph above, the predicted values of life satisfaction from the interaction effect between environmental concerns and age (while keeping everything else constant) are consistently negative with the same slope, which means that there is no meaningful interaction. One of the reasons might lie in the fact that very often respondents drop out from the survey and overtime changes in their behavior are no longer feasible to track. Moreover, environmental concerns are only available in three categories, which constraints the analysis. The interactions results are similarly meaningless for employment. A possible explanaiton of the finding is that the dummy variable might not represent the full socio-economic situation of an individual. 
=======

However, as shown in the graph above, the predicted values of life satisfaction from the interaction effect between environmental concerns and age (while keeping everything else constant) are consistently negative with the same slope, which means that there is no meaningful interaction. One of the reasons might lie in the fact that very often respondents drop out from the survey and overtime changes in their behavior are no longer feasible to track. Moreover, environmental concerns are only available in three categories, which constraints the analysis. The interactions results are similarly meaningless for employment. A possible explanation of the finding is that the dummy variable might not represent the full socio-economic situation of an individual. 
>>>>>>> master

``` {r, echo=FALSE}
data$emp <- as.factor(data$emp)
Model.4<-lme(satis~fam+gender+environ*emp+CO2perSqKm+age,
            random=~1+environ*emp|Stateid,data=data,control=list(opt="optim"))
efemp <- effect("environ*emp", Model.4)
xemp <- as.data.frame(efemp)
Model4 <- ggplot(xemp, aes(emp, fit, color=environ))+
geom_point() + geom_errorbar(aes(ymin=fit-se, ymax=fit+se), width=0.4) + theme_bw(base_size=12) +
  ylab("Predicted satisfaction values") +
  xlab("Employment status [1-no, 2-yes]")
  
Model4 + ggtitle("Model.4. Interaction effects of environmental concerns\nand employment")
```