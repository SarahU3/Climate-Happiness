---
title: "Multilevel_final"
output: pdf_document
---
## Multilevel Analysis

```{r, echo=FALSE}
possibles <- c('~/GitHub', 
               '~/Documents/Hertie 2016/Collaborative Social Science Data/Research Project/GitHub/')
set_valid_wd(possibles)

source('Climate-Happiness/Data/SourceFile.R')
finaldata <- read.csv("All_Merged_Data.csv")
data <- read.csv("Broad_Data.csv")
attach(finaldata)

```
Since the pooled OLS and Fixed Effects Models do not account for the nested nature of the data and hence do not allow across-state analysis, Multilevel Coefficient Models (MCM) are applied in order to investigate the effects of individual and Bundesland-level factors on happiness. Not only the MCM examine individual variation within and across groups, but they also permit non-independence of individual factors from the group level variables (i.e. different slopes with varying intercepts). The first step of the MCM investigates whether statistically significant variation between Bundeslaender in terms of mean individual satisfaction exists. Otherwise, simpler OLS and panel-data models are more applicable for the given research. The second step involves exploration of the between-group variation based, while the third step completes the analysis by including random slope factors (both individual- and state-level). In addition to the general data set ($$data_1$$, 61,009 observations) familiar to the reader before, given research utilizes a broader data frame (data2, 142,224 observations) expanding the sample to both employed and non-employed respondents. Gross income, however, is dropped due to the data constraints. The models used for the multilevel analysis and corresponding datasets are summarized below.

Null.Models (run on $$data_1$$) checks whether reliable and significant variation between the States exists.
Model.1 ($$data_1$$) tests how the effects of environmental concerns emissions per sq. km. differ across the Bundeslaender.
Model.2 ($$data_1$$) incorporates invidual-level characteristics (income, age, gender, family status) and explores how these factors impact well-being across and among States. 
Model.2a ($$data_2$$) resembles Model.2, except runs on the broader sample of both employed and unemployed respondents dropping income. 
Model.3 ($$data_1$$) presents an interaction effect between environmental concerns and income.
Model.4 ($$data_2$$) presents an interaction effect between environmental concerns and age.

### Step 1. Significant variation. 

An unconditional model, *Null.Model*, serves the first purpose: the model only controls for the State that specifies that the variation intercept is a function of residence.


```{r, echo=FALSE}
Null.Model<-lme(satis~1,random=~1|Stateid,data=finaldata,
                  control=list(opt="optim"))
VarCorr(Null.Model)
``` 

The model examines how much of the average individual life satisfaction is explained by the residence of a respondent through R's general purpose optimization routine (opt="optim"). According to the *Null.Model*, the Bundesland variation (intercept variance) is 0.15, while the within-State residual is 2.6. 
```{r, echo=FALSE}
GREL.DAT<-GmeanRel(Null.Model)
names(GREL.DAT)
mean(GREL.DAT$MeanRel)
Null.Model.2<-gls(satis~1,data=finaldata,
                    control=list(opt="optim"))
logLik(Null.Model.2)*-2
logLik(Null.Model)*-2
sigtest <- round((logLik(Null.Model.2)*-2)-(logLik(Null.Model)*-2), digits=3)
```

Furthermore, the *GmeanRel* function (*multilevel* package) yields the mean reliability of 16 Bundeslaender, which, in this case, is substantially high (`r round(mean(GREL.DAT$MeanRel), digits=3)`). As the cut-off point for acceptable reliability is 0.7, the Bundeslaeander group reliability meets the threshold. The difference between the -2 log likelihood values of *Null.Model* and *Null.Model.2* tests whether the between-State effect is present compared to the random variation in life satisfaction without any control variables. According to the results, the difference is more than substantially large based on the Chi-Squared distribution with 2 degrees of freedom (`r sigtest`). These results suggest that there is significant State variation in happiness level, which justifies the usage of the MCM. 

### Step 2. 
The second step of the MCM looks into how both Bundesland emissions and subjective concerns about the environment influence reported individual life satisfaction. *Model.1* (*lme* function) for the time being does not control for individual characteristics, such as gender, age, employment and family status. *Model.1* serves as the basic tool to understand relationship between the group- and individual-level factors representing the environment. 

```{r, echo=FALSE, results='as is'}
Model.1<-lme(satis~environ+CO2perSqKm,random=~1+environ+CO2perSqKm|Stateid, data=finaldata,
             control=list(opt="optim"))
stargazer::stargazer(Model.1, single.row = TRUE,
                     dep.var.labels = "Life Satisfaction",
                     title = 'Model.1: Environmental Factors ',
                     digits = 2, type = 'latex')
```

The output demonstrates that both coefficients are negative as expected. However, a plot of the relationship between emissions and life satisfaction across all Bundeslaender demonstrates that in some States (Niedersachsen, Nordrhein-Westhafen, Baden-Wuerttemberg, Brandenburg) emissions positively influence the well-being of the residents. These results, nevertheless, do not represent the reality, as one should keep in mind numerous omitted variables from this simplistic model.   
```{r, echo=FALSE}
model.01 <-lme(satis~CO2perSqKm,random=~CO2perSqKm|Stateid, data=finaldata, control=list(opt="optim"))
pframe_carbon <- with(finaldata,            expand.grid(Stateid=levels(Stateid),                           CO2perSqKm=seq(min(CO2perSqKm),max(CO2perSqKm),length=51)))
pframe_carbon$satis <- predict(model.01,newdata=pframe_carbon,level=1)
model01 <- ggplot(finaldata,aes(CO2perSqKm,satis,colour=Stateid))+
  geom_point()+
  geom_line(data=pframe_carbon)+
  ylab("Satisfaction")+
  xlab("CO2 emissions/sqkm")
model01 + ggtitle("Effect of emissions/sqkm across States")
```

Simultaneously, stronger environmental concerns do seem to lower well-being across all the Bundeslaender, though to a varying degree. Moreover, the graph shows how throughout Germany, life satisfaction level does not differ substantially, if ran against the environmental concerns. This phenomenon is usually observed, as individuals tend to adjust to their life circumstances and judge their quality of life compared to their peers and neighbours.
```{r, echo=FALSE}
finaldata$environ <- as.numeric(as.character(finaldata$environ))
model.02 <-lme(satis~environ,random=~environ|Stateid, data=finaldata, control=list(opt="optim"))
pframe <- with(finaldata,
               expand.grid(Stateid=levels(Stateid),                           environ=seq(min(environ),max(environ),length=3)))
pframe$satis <- predict(model.02,newdata=pframe,level=1)
model02 <- ggplot(finaldata,aes(environ,satis,colour=Stateid))+
  geom_point()+
  geom_line(data=pframe)+
  ylab("Satisfaction")+
  xlab("Concerns about the environment")
model02 + ggtitle("Effects of environmental concerns across States")
```

Furthermore, state emissions are indeed negatively related to the individual happiness. However, the negligent magnitude of the coefficient (-0.000063) is also not statistically significant. Consequently, the group-level effect does not significantly differ from the individual-level one. On the other hand, the coefficient of environmental concerns (-0.075) statistically differs from 0.  

These results point at the omitted variables (absence of the demographic characteristics) that should be included in the further model. 

A brief overview of *Model.2*, which covers demographic characteristics, reassures the anticipation about the State emissions: the coefficient became significant after controlling for other individual factors. As a result, the difference between State- and individual-level slopes exists and permit multilevel analysis. However, the coefficient of environmental concerns is still positive, which is to be discussed together with other factors in the final paper. 

```{r, echo=FALSE}
Model.2<-lme(satis~environ+Emissions+age+fam+gender+emp,random=~1|Stateid,data=finaldata,
             control=list(opt="optim"))

summary(Model.2)
```