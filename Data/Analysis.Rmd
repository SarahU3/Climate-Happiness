---
title: 'Assignment #3'
author: "Katie Levesque, Sarah Unbehaun, Meerim Ruslanova"
date: "April 14, 2016"
output: pdf_document
---

## Quick recap

This project aims to investigate the relationship between happiness levels across German Federal States (Bundeslaender) and among individuals over the time horizon from 1990 to 2012. More specifically, this projects explores whether the state level emissions, as well as personal characteristics, affect life satisfaction of German citizens? The hypotheses state: 

> *H1: Bundeslaender with higher emissions will have lower reported levels of health, well-being, or life satisfaction.* 

> *H2: Reported levels of health, well-being or life satisfaction will reflect changes in emissions in line with hypothesis above, i.e. as emissions decline, reported levels of health, well-being, and life satisfaction will rise.*


## Data

The individual-level data is provided by the German Socio-Economic Panel Data [GSOEP]( https://paneldata.org/) conducted by the German Institute for Economic Research [DIW]( https://www.diw.de/en/diw_02.c.101738.en/about_us/about_us.html). Due to the confidentiality restrictions, DIW could only supply a shortened sample with prior specified variables in a *.dta* format. Therefore, the GSOEP dataset is stored on the local drives and GitHub Climate-Happiness Repository. The original GSOEP file is cleaned and transformed into a shorter dataset with the help of the State Do-File. The short dataset contains the information on the main variables: reported levels of life satisfaction (on a scale from 0 to 10), subjective concerns about the environment, age, gender, employment, family status, and state residence of a respondent. Detailed labels and description of the variables are given in the GSOEP codebook. Likewise, all GSOEP related files are stored on the GitHub server. 

The state-level data, on the other hand, is gathered from three web-based sources: State Initiative for Core Indicators [LIKI](http://www.lanuv.nrw.de/liki/index.php?indikator=608&aufzu=1&mode=indi), [Statista.com]( http://de.statista.com/statistik/daten/studie/258063/umfrage/kohlendioxid-emissionen-je-einwohner-in-nordrhein-westfalen/), Environmental-Economic Accounting of the Bundeslaender [UGRdL](http://www.ugrdl.de/tab34.htm) and Agency for Renewable Agency of North Rhine-Westphalia [AfEE](http://www.foederal-erneuerbar.de/landesinfo/bundesland/NRW/kategorie/wirtschaft/ordnung/2010). 

A university subscription to *Statista.com* enabled access to historic state emissions from 1990 to 2012 for most of the Bundeslaender except North Rhine-Westphalia (NRW). Since the website allows data downloads only in *Excel* and provides no unique URLs for each of them, 15 individual files were downloaded manually on a local machine, while manipulations were conducted with the help of R loops. The information on NRW was slightly involved more intensive research and data handling. Finally, the NRW annual emissions were gathered and combined from the UGRdL (from 1990 to 2000) and *AfEE* (from 2000 to 2012) with R web-scraping functions. Fortunately, emissions are measured in the same units (annually emitted Carbon dioxide tons per capita). Hence, the yielded data frame of emissions is comprehensive and consistent, although there are missing observations on some years. 

Simultaneously, the state efforts to curb their emissions and preserve local environment are reflected in their renewable energy indicators. This information is measured in percentage of renewables in the annual primary energy consumption, final energy consumption, and electricity consumption. The indicators had to be downloaded manually from *LIKI* in three separate excel files, which later on were cleaned, transformed and reshaped into suitable data frames in R. 

After the names of the Bundeslaender and the time frame of the three produced data frames match, they are easily merged in R into a final data set. 


```{r, include=FALSE}
setwd('~/GitHub/Climate-Happiness/Data')
source('~/GitHub/Climate-Happiness/Data/SourceFile.R')
data <- read.csv("All_Merged_Data.csv")
attach(data)
```

## Descriptive Statistics

```{r, echo=FALSE}
summary(State)

```

```{r, echo=FALSE}

#Boxplot of emissions levels by state
names(data)
data.frame(data)
boxplot(Emissions~State,
  data=data,
  main="Emissions by State",
  xlab="State",
  ylab="Emissions (annual tons of CO2 per capita)",
  col="royalblue1",
  border="royalblue4"
)
```

```{r, echo=FALSE}
# Line graph of emissions levels by state over time
ggplot(data, aes(x = Year, y = Emissions, group = State, color = State)) + geom_line() + scale_colour_discrete() +labs(y = "Emissions (annual tons of CO2 per capita)")
```

```{r, echo=FALSE}
#Boxplot of life satisfaction by state
boxplot(satis~State,
  data=data,
  main="Satisfaction by State",
  xlab="State",
  ylab="Satisfaction (0-10)",
  col="royalblue1",
  border="royalblue4"
)
```

```{r, echo=FALSE}
qplot(data$State, data$Emissions, geom = "boxplot", main = "Emissions by State", xlab = "State", ylab = "Emissions", fill = factor(data$State)) + guides(fill=FALSE)
```

```{r, echo=FALSE}

#panel data scatterplot of aggregate state satisfaction over years
scatterplot(satis~Year|State, boxplots=FALSE, smooth=TRUE, reg.line=FALSE, data=data)
```


```{r, echo=FALSE}
##Regression using individual level data

#Declare X and Y variables for panel data
Y1<-cbind(satis_labels)
X1<-cbind(Emissions, Use, environ, gender, age)

#set data as panel data
pdataind<-plm.data(data, index=c("pid","Year"))

summary(X1)
summary(Y1)

#pooled OLS estimator
L1<-plm(Y1~X1, data=pdataind, model="pooling")
summary(L1)

#between estimator
L2<-plm(Y1~X1, data=pdataind, model="between")
summary(L2)

#first difference estimator
L3<-plm(Y1~X1, data=pdataind, model="fd")
summary(L3)

#fixed effects or within estimator
L4<-plm(Y1~X1, data=pdataind, model="within")
summary(L4)

#LM test for fixed effects vs OLS
pFtest(L2,L1)


#output table with findings - need to change code depending on output desired
library(stargazer)
stargazer(L1, L2, L3, L4,
    title = 'Regression Estimates of Life Satisfaction',
    digits = 2, type = 'html'
    )
```



```{r descr, echo=FALSE}
#Find the range pf emissions values to create a 95% confidence interval for between regression
range(satis)
Satisfaction_range<-1:4

#extract point estimates and co-variance matrix
L2_coef <- matrix(coef(L2))
L2_vcov <- vcov(L2)

#draw 1000 simulations of the point estimates
library(MASS) # contains the mvrnorm function
drawn <- mvrnorm(n = 1000, mu = L2_coef, Sigma = L2_vcov) %>% 
            data.frame
head(drawn)[1:3, ]

drawn_sim <- merge(drawn, Satisfaction_range)

# Rename the fitted value variable
drawn_sim <- dplyr::rename(drawn_sim, fitted_satisfaction = y)

nrow(drawn)
nrow(drawn_sim)

#calculate the quantity of interest 
names(drawn_sim)
drawn_sim$sim_wc <- drawn_sim[, 1] + drawn_sim[, 2] * drawn_sim[, 5] + 
                        drawn_sim[, 3]

#plot points
ggplot(drawn_sim, aes(fitted_satisfaction, sim_wc)) + 
        geom_point(alpha = 0.2) + stat_smooth(se = FALSE) +
        theme_bw()

# Find 95% central interval and median at each fitted value of edu
central <- drawn_sim %>% group_by(fitted_satisfaction) %>%
            summarise(median_sim = median(sim_wc),
                      lower_95 = quantile(sim_wc, probs = 0.025),
                      upper_95 = quantile(sim_wc, probs = 0.975)
            )

#plot 95% confidence interval
ggplot(central, aes(fitted_satisfaction, median_sim)) +
    geom_ribbon(aes(ymin = lower_95, ymax = upper_95), alpha = 0.3) +
    geom_line() + theme_bw()

```

## Multilevel analysis

First step of the MRC 

```{r, include=FALSE}
Null.Model<-lme(satis~1,random=~1|Stateid,data=data,
                  control=list(opt="optim"))
VarCorr(Null.Model)

GREL.DAT<-GmeanRel(Null.Model)
names(GREL.DAT)
mean(GREL.DAT$MeanRel)

Null.Model.2<-gls(satis~1,data=data,
                    control=list(opt="optim"))
logLik(Null.Model.2)*-2
logLik(Null.Model)*-2
sigtest <- (logLik(Null.Model.2)*-2)-(logLik(Null.Model)*-2)
```
