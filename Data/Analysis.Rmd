---
title: 'Assignment #3'
author: "Katie Levesque, Sarah Unbehaun, Meerim Ruslanova"
date: "April 14, 2016"
output: html_document
---

## Quick Recap

This project aims to investigate the relationship between happiness levels across German Federal States (Bundeslaender) and among individuals over the time horizon from 1990 to 2012. More specifically, this projects explores whether the state level emissions, as well as personal characteristics, affect life satisfaction of German citizens? The hypotheses state: 

> *H1: Bundeslaender with higher emissions inversely affect reported levels of life satisfaction.* 

> *H2: Reported individual concerns with the environment are, likewise, negatively reflected in the life satisfaction.*

Model 1 combines these two hypotheses:
$satis=\beta_0 - \beta_1*Emissions + \beta_2*EnvironConcerns + u_j + r_i$ 

The relationship between the independent and dependent variables is explored on both individual and State level via the multilevel modelling. 


## Data

The individual-level data is provided by the German Socio-Economic Panel Data [GSOEP]( https://paneldata.org/) conducted by the German Institute for Economic Research [DIW]( https://www.diw.de/en/diw_02.c.101738.en/about_us/about_us.html). Due to the confidentiality restrictions, DIW could only supply a shortened sample with prior specified variables in a *.dta* format. Therefore, the GSOEP dataset is stored on the local drives and GitHub Climate-Happiness Repository. The original GSOEP file is cleaned and transformed into a shorter dataset with the help of the State Do-File. The short dataset contains the information on the main variables: reported levels of life satisfaction (on a scale from 0 to 10), subjective concerns about the environment, age, gender, employment, family status, and state residence of a respondent. Detailed labels and description of the variables are given in the GSOEP codebook. Likewise, all GSOEP related files are stored on the GitHub server. 

The state-level data, on the other hand, is gathered from three web-based sources: State Initiative for Core Indicators [LIKI](http://www.lanuv.nrw.de/liki/index.php?indikator=608&aufzu=1&mode=indi), [Statista.com]( http://de.statista.com/statistik/daten/studie/258063/umfrage/kohlendioxid-emissionen-je-einwohner-in-nordrhein-westfalen/), Environmental-Economic Accounting of the Bundeslaender [UGRdL](http://www.ugrdl.de/tab34.htm) and Agency for Renewable Agency of North Rhine-Westphalia [AfEE](http://www.foederal-erneuerbar.de/landesinfo/bundesland/NRW/kategorie/wirtschaft/ordnung/2010). 

A university subscription to *Statista.com* enabled access to historic state emissions from 1990 to 2012 for most of the Bundeslaender except North Rhine-Westphalia (NRW). Since the website allows data downloads only in *Excel* and provides no unique URLs for each of them, 15 individual files were downloaded manually on a local machine, while manipulations were conducted with the help of R loops. The information on NRW was slightly involved more intensive research and data handling. Finally, the NRW annual emissions were gathered and combined from the UGRdL (from 1990 to 2000) and *AfEE* (from 2000 to 2012) with R web-scraping functions. Fortunately, emissions are measured in the same units (annually emitted Carbon dioxide tons per capita). Hence, the yielded data frame of emissions is comprehensive and consistent, although there are missing observations on some years. 

Simultaneously, the state efforts to curb their emissions and preserve local environment are reflected in their renewable energy indicators. This information is measured in percentage of renewables in the annual primary energy consumption, final energy consumption, and electricity consumption. The indicators had to be downloaded manually from *LIKI* in three separate excel files, which later on were cleaned, transformed and reshaped into suitable data frames in R. 

After the names of the Bundeslaender and the time frame of the three produced data frames match, they are easily merged in R into a final data set. 


```{r, include=FALSE}
setwd('~/GitHub/Climate-Happiness/Data')
source('~/GitHub/Climate-Happiness/Data/SourceFile.R')
data <- read.csv("All_Merged_Data.csv")
attach(data)
```

## Descriptive Statistics

```{r, echo=FALSE}
summary(State)

```
The data has a wide range in terms of the number of observations for each federal state. If we look a little closer, separating them by year, we see that some states are missing observations for a few years:
```{r, echo=FALSE}
table(State, Year)

```
Analysis using Saarland, Nordrhein-Westfalen, and Hamburg may require some adjustment with the missing years in mind. 


Because we are looking at emissions and happiness over a period of years, the values of emissions for each Bundesland also vary, which we can see over time (noting that Saarland is again missing data for some years). 
```{r, echo=FALSE}

#Boxplot of emissions levels by state
ggplot(data, aes(x=State, y=Emissions), main = "Emissions by State", xlab = "State", ylab = "Emissions") +geom_boxplot(aes(fill=factor(State))) + scale_colour_discrete() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) + guides(fill=FALSE)
```

```{r, echo=FALSE}
# Line graph of emissions levels by state over time
ggplot(data, aes(x = Year, y = Emissions, group = State, color = State)) + geom_line() + scale_colour_discrete() +labs(y = "Emissions (annual tons of CO2 per capita)")
```


The other primary variable of interest is life satisfaction. These plots show, again, variation within each state and the variation in life satisfaction across years, mapped as the mean of observations from each state. 

```{r, echo=FALSE}
#Boxplot of life satisfaction by state 
ggplot(data, aes(x=State, y=satis), main = "Average Life Satisfaction by State", xlab = "State", ylab = "Satisfaction") +geom_boxplot(aes(fill=factor(State))) + scale_colour_discrete() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) + guides(fill=FALSE)
```

```{r, echo=FALSE}
aggremeans <- aggregate(data[, c(1, 3, 6, 18, 19, 22)], list(State, Year), mean)
ggplot(aggremeans, aes(x = Year, y = satis, group = Group.1, color = Group.1)) + geom_line() + scale_colour_discrete() +labs(y = "Life Satisfaction")
```

Again using the means of each state, we can create some scatterplots showing correlation between variables. Life satisfaction appears to be positively correlated with age, energy use, and concern about the environment, but does not show a strong correlation with emissions. 

```{r, echo=FALSE}
# scatterplots of aggregate state satisfaction over years
ggplot(data = aggremeans, aes(x=age, y=satis)) + geom_point() +geom_smooth(method = lm, se = FALSE) + labs(x = "Age", y = "Life Satisfaction")
ggplot(data = aggremeans, aes(x=Emissions, y=satis)) + geom_point() +geom_smooth(method = lm, se = FALSE) + labs(x = "Emissions per Capita", y = "Life Satisfaction")
ggplot(data = aggremeans, aes(x=Use, y=satis)) + geom_point() +geom_smooth(method = lm, se = FALSE) + labs(x = "Energy Use per Capita", y = "Life Satisfaction")
ggplot(data = aggremeans, aes(x=environ, y=satis)) + geom_point() +geom_smooth(method = lm, se = FALSE) + labs(x = "Concern about the Environment", y = "Life Satisfaction")
```



## Inferential Statistics

To run inferential statistics, we first create "pdataind" as panel data. For the models below, Y1 represents "satis" (life satisfaction), measured on a scale ranging from 0 to 10. X1 represents the other variables of interest: Emissions, Energy Use, Concern for the Environment, Gender, and Age. We know that the data set is unbalanced, as we noticed earlier that we don't have information for all years from all the states.

```{r, echo=FALSE, quiet}
##Regression using individual level data

#Declare X and Y variables for panel data
Y1<-cbind(satis)
X1<-cbind(Emissions, Use, environ, gender, age)

#set data as panel data
pdataind<-plm.data(data, index=c("pid","Year"))

summary(X1)
summary(Y1)

```


Below, we tested various types of panel data models on our individual-level data.  

```{r, echo=FALSE}
#pooled OLS estimator
L1<-plm(Y1~X1, data=pdataind, model="pooling")
summary(L1)

#between estimator
L2<-plm(Y1~X1, data=pdataind, model="between")
summary(L2)

#first difference estimator
L3<-plm(Y1~X1, data=pdataind, model="fd")
summary(L3)

#fixed effects or within estimator
L4<-plm(Y1~X1, data=pdataind, model="within")
summary(L4)

#output table with findings - will need to be xtable or texreg, stargazer not compatible with knit
```

In terms of explanatory power, the first difference and within estimators appear to be less useful than the between or pooled OLS estimators, as their R-squared and adjusted R-squared are very low.Interestingly, gender does not appear to have a significant effect on reported life satisfaction in any of the models.  

```{r, echo=FALSE}
#LM test for fixed effects vs OLS
pFtest(L2,L1)

```



```{r descr, echo=FALSE}
#Find the range pf emissions values to create a 95% confidence interval for between regression
range(satis)
Satisfaction_range<-1:4

#extract point estimates and co-variance matrix
L2_coef <- matrix(coef(L2))
L2_vcov <- vcov(L2)

#draw 1000 simulations of the point estimates
library(MASS) # contains the mvrnorm function
drawn <- mvrnorm(n = 1000, mu = L2_coef, Sigma = L2_vcov) %>% 
            data.frame
head(drawn)[1:3, ]

drawn_sim <- merge(drawn, Satisfaction_range)

# Rename the fitted value variable
drawn_sim <- dplyr::rename(drawn_sim, fitted_satisfaction = y)

nrow(drawn)
nrow(drawn_sim)

#calculate the quantity of interest 
names(drawn_sim)
drawn_sim$sim_wc <- drawn_sim[, 1] + drawn_sim[, 2] * drawn_sim[, 5] + 
                        drawn_sim[, 3]

#plot points
ggplot(drawn_sim, aes(fitted_satisfaction, sim_wc)) + 
        geom_point(alpha = 0.2) + stat_smooth(se = FALSE) +
        theme_bw()

# Find 95% central interval and median at each fitted value of edu
central <- drawn_sim %>% group_by(fitted_satisfaction) %>%
            summarise(median_sim = median(sim_wc),
                      lower_95 = quantile(sim_wc, probs = 0.025),
                      upper_95 = quantile(sim_wc, probs = 0.975)
            )

#plot 95% confidence interval
ggplot(central, aes(fitted_satisfaction, median_sim)) +
    geom_ribbon(aes(ymin = lower_95, ymax = upper_95), alpha = 0.3) +
    geom_line() + theme_bw()

```


## Multilevel Analysis: Basic Steps

Multilevel Coefficient Models (MCM, *multilevel* and *nlme* packages) appear as one of the options to proceed with the multilevel analysis. MCM examines individual variation within and across groups, as well as permits non-independence of individual factors from the group level variables. The first step of the MCM investigates whether statistically significant variation between Bundeslaender in terms of mean individual satisfaction exists. Otherwise, simpler OLS and panel-data models are more applicable for the given research. 

An unconditional model, *Null.Model*, serves the first purpose: the model only controls for the State that specifies that the variation intercept is a function of residence.
```{r, echo=FALSE}
Null.Model<-lme(satis~1,random=~1|Stateid,data=data,
                  control=list(opt="optim"))
VarCorr(Null.Model)
``` 
The model examines how much of the average individual life satisfaction is explained by the residence of a respondent through R's general purpose optimization routine (opt="optim"). According to the *Null.Model*, the Bundesland variation (intercept variance) is 0.19, while the within-State residual is 3.17. 

```{r, echo=FALSE}
GREL.DAT<-GmeanRel(Null.Model)
names(GREL.DAT)
mean(GREL.DAT$MeanRel)
Null.Model.2<-gls(satis~1,data=data,
                    control=list(opt="optim"))
logLik(Null.Model.2)*-2
logLik(Null.Model)*-2
sigtest <- round((logLik(Null.Model.2)*-2)-(logLik(Null.Model)*-2), digits=3)
```
Furthermore, the *GmeanRel* function (*multilevel* package) yields the mean reliability of 16 Bundeslaender, which, in this case, is substantially high (`r round(mean(GREL.DAT$MeanRel), digits=3)`). As the cut-off point for acceptable reliability is 0.7, Bindeslaeander group reliability meets the threshold. The difference between the -2 log likelihood values of *Null.Model* and *Null.Model.2* tests whether the between-State effect is present compared to the random variation in life satisfaction without any control variables. According to the results, the difference is significantly large based on the Chi-Squared distribution with 2 degrees of freedom (`r sigtest`). These results suggest that there is significant State variation in happiness level, which justifies the usage of the MCM. 

The second step of the MCM looks into how both Bundesland emissions and subjective concerns about the environment influence reported individual life satisfaction. *Model.1* (*lme* function) for the time being does not control for individual characteristics, such as gender, age, employment and family status. Moreover, percentage of the renewables (which is anticipated to directly relate to the life satisfaction) will be also examined in the later phase of the research. *Model.1* serves as the basic tool to understand relationship between the group- and individual-level factors representing the environment. 
```{r, echo=FALSE}
Model.1<-lme(satis~environ+Emissions,random=~1|Stateid,data=finaldata,
             control=list(opt="optim"))

summary(Model.1)
```
The output demonstrates that the State emissions are indeed negatively related to the individual happiness. However, after controlling for the individual environmental concerns, the coefficient (-0.005) is not statistically significant. Consequently, the group-level effect does not significantly differ from the individual-level. On the other hand, the coefficient of environmental concerns statistically differs from 0, but the direction is oddly positive counter the expectations. These results point at the omitted variables (absence of the demographic characteristics) that should be included in the further model. Similarly, the surprising direction of the environmental coefficient demands investigation of endogeneity between reported happiness and environmental concerns. 

A brief overview of *Model.2*, which covers demographic characteristics, reassures the anticipation about the State emissions: the coefficient became significant after controlling for other individual factors. As a result, the difference between State- and individual-level slopes exists and permit multilevel analysis. However, the coefficient of environmental concerns is still positive, which is to be discussed together with other factors in the final paper. 

```{r, echo=FALSE}
Model.2<-lme(satis~environ+Emissions+age+fam+gender+emp,random=~1|Stateid,data=finaldata,
             control=list(opt="optim"))

summary(Model.2)
```
